<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>GIS WASM 坐标转换测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .input-group { margin: 10px 0; }
        label { display: inline-block; width: 120px; }
        input { padding: 5px; margin: 5px; }
        button { padding: 10px 20px; background: #007cba; color: white; border: none; cursor: pointer; }
        .result { margin: 20px 0; padding: 10px; background: #f0f0f0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <div class="container">
        <h1>GIS WASM 坐标转换测试</h1>
        
        <div class="input-group">
            <label>经度 (Longitude):</label>
            <input type="number" id="longitude" value="116.404" step="any">
        </div>
        
        <div class="input-group">
            <label>纬度 (Latitude):</label>
            <input type="number" id="latitude" value="39.915" step="any">
        </div>
        
        <div class="input-group">
            <label>源坐标系 EPSG:</label>
            <select id="fromEpsg">
                <option value="4326">4326 (WGS84 经纬度)</option>
                <option value="3857">3857 (Web Mercator)</option>
                <option value="4258">4258 (ETRS89)</option>
                <option value="4269">4269 (NAD83)</option>
                <option value="4490">4490 (CGCS2000)</option>
            </select>
        </div>
        
        <div class="input-group">
            <label>目标坐标系 EPSG:</label>
            <select id="toEpsg">
                <option value="3857">3857 (Web Mercator)</option>
                <option value="4326">4326 (WGS84 经纬度)</option>
                <option value="4258">4258 (ETRS89)</option>
                <option value="4269">4269 (NAD83)</option>
                <option value="4490">4490 (CGCS2000)</option>
            </select>
        </div>
        
        <button onclick="transformCoordinate()">转换坐标</button>
        <button onclick="runTests()">运行测试用例</button>
        
        <div id="result" class="result" style="display: none;"></div>
        
        <h2>预定义测试用例</h2>
        <p>点击"运行测试用例"将测试以下转换：</p>
        <ul>
            <li>北京天安门: WGS84 (116.404, 39.915) → Web Mercator</li>
            <li>上海东方明珠: WGS84 (121.506, 31.245) → Web Mercator</li>
            <li>Web Mercator → WGS84 反向转换</li>
            <li>GeoJSON 面积计算（来自 aaa.geojson，简化：投影到 Web Mercator 后鞋带公式）</li>
            <li>两点间哈弗辛距离（北京 ↔ 上海）</li>
        </ul>
    </div>

    <script type="module">
        import init, { transform_point, JsPoint, haversine_distance, bbox } from './pkg/GIS_Wasm_Algorithm.js';
        
        let wasm;
        
        async function run() {
            wasm = await init();
            console.log('WASM 模块加载成功');
            
            // 使全局可用
            window.transform_point = transform_point;
            window.JsPoint = JsPoint;
            window.haversine_distance = haversine_distance;
            window.bbox = bbox;
        }
        
        window.transformCoordinate = function() {
            if (!wasm) {
                showResult('WASM 模块尚未加载完成', 'error');
                return;
            }
            
            const lon = parseFloat(document.getElementById('longitude').value);
            const lat = parseFloat(document.getElementById('latitude').value);
            const fromEpsg = parseInt(document.getElementById('fromEpsg').value);
            const toEpsg = parseInt(document.getElementById('toEpsg').value);
            
            try {
                const result = transform_point(lon, lat, fromEpsg, toEpsg);
                const resultText = `
                    <strong>转换成功!</strong><br>
                    输入坐标: (${lon}, ${lat}) EPSG:${fromEpsg}<br>
                    输出坐标: (${result.x.toFixed(6)}, ${result.y.toFixed(6)}, ${result.z.toFixed(6)}) EPSG:${toEpsg}
                `;
                showResult(resultText, 'success');
            } catch (error) {
                showResult(`转换失败: ${error}`, 'error');
            }
        };
        
        window.runTests = async function() {
            if (!wasm) {
                showResult('WASM 模块尚未加载完成', 'error');
                return;
            }
            
            const testCases = [
                {
                    name: '北京天安门 WGS84 → Web Mercator',
                    lon: 116.404, lat: 39.915, from: 4326, to: 3857
                },
                {
                    name: '上海东方明珠 WGS84 → Web Mercator',
                    lon: 121.506, lat: 31.245, from: 4326, to: 3857
                },
                {
                    name: 'Web Mercator → WGS84 (反向转换)',
                    lon: 12958742.0, lat: 4825771.0, from: 3857, to: 4326
                }
            ];
            
            let results = '<strong>测试结果:</strong><br>';
            let passCount = 0;
            
            // 投影转换用例
            testCases.forEach((test) => {
                try {
                    const result = transform_point(test.lon, test.lat, test.from, test.to);
                    results += `✅ ${test.name}: (${result.x.toFixed(6)}, ${result.y.toFixed(6)})<br>`;
                    passCount++;
                } catch (error) {
                    results += `❌ ${test.name}: 失败 - ${error}<br>`;
                }
            });

            results += `<br><strong>通过: ${passCount}/${testCases.length}</strong><br>`;

            // 哈弗辛距离计算（北京 ↔ 上海）
            try {
                const dist = haversine_distance(116.404, 39.915, 121.506, 31.245);
                results += `📏 哈弗辛距离（北京 ↔ 上海）: ${(dist / 1000).toFixed(2)} km<br>`;
            } catch (error) {
                results += `❌ 哈弗辛距离计算失败: ${error}<br>`;
            }

            // 从 aaa.geojson 读取并计算面积（简化：投影到 Web Mercator 后用鞋带公式求面积，单位 m²）
            try {
                const resp = await fetch('aaa.geojson');
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();

                // 提取几何
                let geom = null;
                if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 0) {
                    geom = data.features[0].geometry;
                } else if (data && data.type === 'Feature' && data.geometry) {
                    geom = data.geometry;
                } else if (data && data.type && data.coordinates) {
                    geom = data; // 已是 Geometry
                }
                if (!geom) throw new Error('无法从 aaa.geojson 提取几何 Geometry');

                // 工具函数：去掉闭合重复点
                const cleanRing = (ring) => {
                    if (!ring || ring.length < 3) return ring || [];
                    const first = ring[0];
                    const last = ring[ring.length - 1];
                    if (first[0] === last[0] && first[1] === last[1]) return ring.slice(0, -1);
                    return ring;
                };

                // 工具函数：鞋带公式面积（已在米单位坐标）
                const ringArea = (ring) => {
                    const r = cleanRing(ring);
                    let area = 0;
                    for (let i = 0, j = r.length - 1; i < r.length; j = i++) {
                        const [x1, y1] = r[j];
                        const [x2, y2] = r[i];
                        area += (x1 * y2 - x2 * y1);
                    }
                    return Math.abs(area) / 2;
                };

                // 将经纬度投影到 Web Mercator（EPSG:3857）
                const projRingTo3857 = (ringLngLat) => ringLngLat.map(([lon, lat]) => {
                    const p = transform_point(lon, lat, 4326, 3857);
                    return [p.x, p.y];
                });

                const areaPolygon3857 = (poly) => {
                    // poly: [outer, hole1, hole2, ...]
                    if (!Array.isArray(poly) || poly.length === 0) return 0;
                    const outer = projRingTo3857(poly[0]);
                    let area = ringArea(outer);
                    for (let i = 1; i < poly.length; i++) {
                        const hole = projRingTo3857(poly[i]);
                        area -= ringArea(hole);
                    }
                    return Math.max(area, 0);
                };

                let areaM2 = 0;
                if (geom.type === 'Polygon') {
                    areaM2 = areaPolygon3857(geom.coordinates);
                } else if (geom.type === 'MultiPolygon') {
                    for (const poly of geom.coordinates) {
                        areaM2 += areaPolygon3857(poly);
                    }
                } else {
                    throw new Error(`暂不支持的几何类型: ${geom.type}`);
                }

                results += `📐 GeoJSON 面积（面积计算，Web Mercator 近似）: ${areaM2.toFixed(2)} m²<br>`;

                // 计算并显示 bbox（直接基于 GeoJSON 原始坐标系）
                try {
                    const box = bbox(geom);
                    const arr = Array.from(box);
                    results += `🧭 BBox: [${arr.map(v => Number(v).toFixed(6)).join(', ')}]` + '<br>';
                } catch (e) {
                    results += `❌ BBox 计算失败: ${e}<br>`;
                }
            } catch (error) {
                results += `❌ GeoJSON 面积计算失败: ${error}<br>`;
            }
            
            showResult(results, passCount === testCases.length ? 'success' : 'error');
        };
        
        function showResult(text, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = text;
            resultDiv.className = 'result ' + type;
            resultDiv.style.display = 'block';
        }
        
        run();
    </script>
</body>
</html>
